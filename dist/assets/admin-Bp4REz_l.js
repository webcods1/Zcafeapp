import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as T}from"./preload-helper-BXl3LOEh.js";import{initializeApp as z}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getDatabase as N,onValue as L,query as S,ref as d,remove as O,orderByChild as A,equalTo as F,update as D}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";const c=localStorage.getItem("adminBranch");c||(alert("Unauthorized access"),location.href="admin-login.html");document.getElementById("branch-label").textContent=c;const _=z({apiKey:"AIzaSyBD_s0bu-ei-bsdPDIFaDF6gbuck-85hbM",authDomain:"zcafe-65f97.firebaseapp.com",databaseURL:"https://zcafe-65f97-default-rtdb.firebaseio.com",projectId:"zcafe-65f97",storageBucket:"zcafe-65f97.firebasestorage.app",messagingSenderId:"480288327990",appId:"1:480288327990:web:9c79040289023919034b97"}),m=N(_),E=document.getElementById("orders-list"),$=document.getElementById("newOrderSound");let f=[],v=0;const h=document.getElementById("service-list");let C=0;L(S(d(m,"service_requests")),e=>{if(h.innerHTML="",!e.exists()){h.innerHTML="<p style='color:#777; grid-column: 1/-1; text-align:center;'>No active service requests.</p>";return}const n=e.val();let a=[];if(console.log("Checking Service Requests..."),Object.entries(n).forEach(([t,r])=>{const o=(r.customerLocation||"").toLowerCase().trim(),s=(c||"").toLowerCase().trim();console.log(`Req [${t}] Loc: "${o}" vs Admin: "${s}"`),(o.includes(s)||s.includes(o)||o==="unknown location"||o==="unknown")&&a.push({id:t,...r})}),a.length===0){h.innerHTML=`<p style='color:#777; grid-column: 1/-1; text-align:center;'>No requests found for ${c}.</p>`;return}C>0&&a.length>C&&($.currentTime=0,$.play().catch(t=>console.log("Audio play failed:",t))),C=a.length,a.reverse().forEach(t=>{const r=t.id,o=document.createElement("div");o.className="order-card",o.style.borderLeft="5px solid #d32f2f",o.innerHTML=`
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div>
                    <strong style="font-size:1.05rem; color:#d32f2f;">${t.type}</strong>
                    <div style="font-size:0.8rem; color:#888; margin-top:2px;">${t.timestamp}</div>
                </div>
                <span class="status-pill" style="background:#fee2e2; color:#b91c1c; height:fit-content; border-radius:12px; font-size:0.75rem;">${t.status}</span>
            </div>
            
            <div style="margin-bottom:12px; font-size:0.95rem;">
                <div style="font-size:0.8rem; color:#666;">Company:</div>
                <strong style="display:block; font-size:1.1rem; color:#111;">${t.customerCompany||"Unknown Company"}</strong>
                <a href="tel:${t.customerPhone}" style="display:inline-block; margin-top:4px; color:#2563eb; text-decoration:none; font-weight:500;">üìû ${t.customerPhone}</a>
                <div style="font-size:0.8rem; color:#888; margin-top:4px;">üìç ${t.customerLocation}</div>
            </div>
            
            <div style="background:#fff5f5; padding:12px; border-radius:8px; margin-bottom:15px; font-size:0.95rem; color:#333; border:1px solid #fee2e2;">
                <strong>Complaint:</strong><br>
                ${t.message}
            </div>
            
            <button onclick="window.deleteService('${r}')" class="service-done-btn">
                ‚úÖ Mark Resolved
            </button>
          `,h.appendChild(o)})});window.deleteService=e=>{confirm("Confirm: Request resolved and can be removed?")&&O(d(m,`service_requests/${e}`))};function k(e){if(!e)return console.log("Empty timestamp received"),"";const n=e.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);return n?`${n[3]}-${n[2]}-${n[1]}`:(console.log("Could not extract date from timestamp:",e),"")}console.log("Admin Branch:",c);L(S(d(m,"orders"),A("customerLocation"),F(c)),e=>{console.log("Orders snapshot exists:",e.exists()),document.getElementById("loading-msg").style.display="none",f=[];let n=0,a=0,t=0;const r=new Date().toISOString().split("T")[0];if(!e.exists()){console.log("No orders found for branch:",c),p();return}console.log("Orders data:",e.val());const o=e.val(),s=Object.keys(o).reverse();console.log(`Found ${s.length} total orders for branch ${c}`),v&&s.length>v&&$.play(),v=s.length,s.forEach(l=>{const i=o[l],u=k(i.timestamp);console.log(`Order ${l}: timestamp=${i.timestamp}, extractedDate=${u}, todayKey=${r}, match=${u===r}`),f.push({id:l,...i}),i.status==="Completed"?t++:a++,u===r&&n++}),todayCount.textContent=n,pendingCount.textContent=a,completedCount.textContent=t,p()});function p(){const e=searchInput.value.toLowerCase(),n=statusFilter.value,a=dateFilter.value;console.log(`Rendering orders - Total: ${f.length}, Search: "${e}", Status: ${n}, Date: ${a}`),E.innerHTML="";const t=f.filter(r=>{const s=`${r.customerPhone||""} ${r.customerCompany||""}`.toLowerCase().includes(e),l=n==="all"||r.status===n,i=!a||k(r.timestamp)===a;return s&&l&&i});console.log(`Filtered orders: ${t.length}`),t.forEach(r=>{const o=document.createElement("div");o.className="order-card"+(r.status==="Completed"?" completed":""),o.innerHTML=`
      <h3>${r.customerCompany||"Customer"}</h3>
      <small>${r.timestamp}</small>
      <p>üìû ${r.customerPhone}</p>
      <ul>${r.items.map(s=>`<li>${s.name} x ${s.quantity}</li>`).join("")}</ul>
      <div class="order-actions">
        <button class="done-btn" onclick="markComplete('${r.id}')">Done</button>
        <button class="delivered-btn" onclick="markDelivered('${r.id}')">Delivered</button>
        <button class="delete-btn" onclick="deleteOrder('${r.id}')">Delete</button>
      </div>
    `,E.appendChild(o)})}searchInput.oninput=p;statusFilter.onchange=p;dateFilter.onchange=p;window.markComplete=e=>confirm("Mark order completed?")&&D(d(m,"orders/"+e),{status:"Completed"});window.markDelivered=e=>confirm("Mark order as Delivered?")&&D(d(m,"orders/"+e),{status:"Delivered"});window.deleteOrder=e=>confirm("Delete order?")&&O(d(m,"orders/"+e));window.logoutAdmin=()=>{localStorage.removeItem("adminBranch"),location.href="admin-login.html"};const w={"Calicut City":["Others"],"Kannur City":["Others"],"Kasarakod City":["Others"],"Vatakara City":["BMH vatakara","C&C vatakara","Keerthimuthra vatakara","Dreame cinemas kallachi","Others"]},g=document.getElementById("notif-location"),y=document.getElementById("notif-company");for(let e in w){let n=document.createElement("option");n.value=e,n.textContent=e,g.appendChild(n)}g.onchange=()=>{const e=g.value;y.innerHTML='<option value="all">Target All Companies</option>',w[e]&&w[e].forEach(n=>{let a=document.createElement("option");a.value=n,a.textContent=n,y.appendChild(a)})};window.sendNotification=()=>{const e=document.getElementById("notif-title").value.trim(),n=document.getElementById("notif-msg").value.trim(),a=g.value,t=y.value;return!e||!n?alert("Fill title and message!"):B(e,n,a,t)};function B(e,n,a,t,r=null){if(!confirm(`Send this to ${a==="all"?"Everyone":t==="all"?a:t}?`))return Promise.resolve(!1);const o=d(m,"notifications/"+Date.now());return M(o,{title:e,message:n,targetLocation:a,targetCompany:t,targetDate:r,timestamp:new Date().toISOString(),sender:c}).then(()=>(alert("Notification sent!"),document.getElementById("notif-title").value="",document.getElementById("notif-msg").value="",!0))}let M;T(()=>import("https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js"),[]).then(e=>{M=e.set});window.markGroupDelivered=async()=>{const e=g.value,n=y.value,a=new Date().toISOString().split("T")[0];if(console.log("Mark Group Delivered clicked:"),console.log("- Selected Location:",e),console.log("- Selected Company:",n),console.log("- Today's Date:",a),console.log("- Total orders loaded:",f.length),e==="all")return alert("Please select a specific location first.");const t=f.filter(o=>{const s=k(o.timestamp),l=o.customerAddress===e||e==="all",i=o.customerCompany===n||n==="all",u=s===a,x=o.status!=="Delivered"&&o.status!=="Completed";return console.log(`Order ${o.id}:`,{customerAddress:o.customerAddress,customerCompany:o.customerCompany,customerLocation:o.customerLocation,orderDate:s,status:o.status,locMatch:l,compMatch:i,dateMatch:u,statusMatch:x}),l&&i&&u&&x});if(console.log("Matching orders found:",t.length),t.length===0){if(alert(`No active orders found for today.

Location: ${e}
Company: ${n}
Date: ${a}

Check console for details.`),!confirm("No orders found. Still send notification to this group?"))return}else if(!confirm(`Found ${t.length} order(s) to mark as Delivered.

Location: ${e}
Company: ${n}

Proceed?`))return;const r={};t.forEach(o=>{r[`orders/${o.id}/status`]="Delivered"}),Object.keys(r).length>0&&(await D(d(m),r),console.log("Updated orders:",Object.keys(r).length)),await B("Delivery Complete!","Your ZCafe order has been delivered! Enjoy your fresh beverages. ‚òï‚ú®",e,n,a),alert(`Success! ${t.length>0?t.length+" order(s) marked as delivered and":""} Notification sent!`)};const I=document.getElementById("notif-templates"),b={miss:{title:"Did you miss your tomorrow order?",msg:"Hi! We noticed you haven't placed your order for tomorrow yet. Don't forget to book your favorite ZCafe treat!"},welcome:{title:"Welcome to ZCafe!",msg:"Thank you for joining our community! Explore our premium coffee and tea collections today."},offer:{title:"Special Discount Inside!",msg:"Exclusive offer for your location! Order now and get a special surprise with your delivery."},delivery:{title:"Delivery Complete!",msg:"Your ZCafe order has been delivered! Enjoy your fresh beverages. ‚òï‚ú®"}};I.onchange=()=>{const e=I.value;b[e]&&(document.getElementById("notif-title").value=b[e].title,document.getElementById("notif-msg").value=b[e].msg)};dateFilter.value=new Date().toISOString().split("T")[0];
